<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebApp</title>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

  <link rel="stylesheet" href="static/css/index.css" />
  <link rel="stylesheet" href="static/css/chat.css" />

  <!-- Markdown -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
  <!-- Higlight code in html markodw -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"> -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  

  <!-- Material Symbols Outlined -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

  <!-- Colormaps -->
  <script src="https://cdn.jsdelivr.net/npm/chroma-js@2.4.2/chroma.min.js"></script>

  
  <!-- Bootstrap -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script> -->


</head>

<body>
  <div id="map"></div>
  <div id="legend" class="legend" style="display:none"></div>

  <!-- CHAT flottante (come originale) -->
  <section id="chat" class="chat" aria-label="Chat con agente AI">
    <header>
      <h4>Assistente AI</h4>
      <!-- x button on right -->
      <span id="chat-window-resizer" class="resize-ico material-symbols-outlined">pip_exit</span>
    </header>
    <div id="chatMsgs" role="log" aria-live="polite"></div>
    <div class="inputRow">
      <textarea id="chatInput" placeholder="Write a message... (Enter to send, Shift+Enter for new line)"></textarea>
      <button class="sendBtn" id="sendBtn">Send</button>
    </div>
    <div class="chat-options">
      <label class="switch blue">
        <input id="chat-option-api" type="checkbox", onchange="toggleChatOptions(event)" checked>
        <span class="slider"></span>
        <span class="label-text">SaferPlaces API</span>
      </label>

      <label class="switch green">
        <input id="chat-option-geo-ops" type="checkbox", onchange="toggleChatOptions(event)">
        <span class="slider"></span>
        <span class="label-text">Geospatial Operations</span>
      </label>

      <label class="switch purple">
        <input id="chat-option-layers" type="checkbox", onchange="toggleChatOptions(event)">
        <span class="slider"></span>
        <span class="label-text">Pass Layers</span>
      </label>
    </div>
  </section>

  <div class="panel">
    <h4>Layer</h4>
    <ul id="layerList">
      <!-- Layer will be added here -->
      <li class="layer-item" draggable="true">
        <span class="icon">ğŸŒ</span>
        <span class="name">Layer di esempio</span>
        <div class="actions">
          <button class="btn menu">â‹®</button>
          <div class="dropdown hidden">
            <div class="dropdown-item">Rinomina</div>
            <div class="dropdown-item">Elimina</div>
            <div class="dropdown-item">Duplica</div>
          </div>
          <span class="eye">ğŸ‘</span>
        </div>
    </ul>
    <hr>
    <!-- Add layer by url s3 http input -->
    <div class="add-layer">
      <label for="layerUrl">Aggiungi layer da URL</label>
      <div class="field">
        <input type="url" id="layerUrl" placeholder="https://...">
        <button onclick="addLayerByUrl()">+</button>
      </div>
    </div>
    <hr>
    <!-- Dropzone drag -->
    <div id="dropzone">Trascina qui file</div>
  </div>



  <script src="static/js/_utils.js"></script>
  <script src="static/js/_map_utils.js"></script>
  <script src="static/js/_chat_utils.js"></script>

  <script>
    // drag & drop riordinamento lista
    const list = document.getElementById('layerList');
    let dragged;
    list.addEventListener('dragstart', e => dragged = e.target);
    list.addEventListener('dragover', e => {
      e.preventDefault();
      const after = [...list.children].find(li =>
        e.clientY < li.getBoundingClientRect().top + li.offsetHeight / 2
      );
      list.insertBefore(dragged, after || null);
    });

    // dropzone upload
    const dz = document.getElementById('dropzone');
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover') });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('dragover');
      [...e.dataTransfer.files].forEach(f => alert("File: " + f.name));
    });

    // toggle occhio
    document.addEventListener("click", e => {
      const isMenuBtn = e.target.classList.contains("menu");

      // Chiudi tutti i menu
      document.querySelectorAll(".dropdown").forEach(dd => dd.classList.add("hidden"));

      // Se ho cliccato su un pulsante menu, riapro SOLO il suo
      if (isMenuBtn) {
        const dd = e.target.parentElement.querySelector(".dropdown");
        dd.classList.remove("hidden");
      }

      // Toggle occhio
      if (e.target.classList.contains("eye")) {
        e.target.textContent = e.target.textContent === "ğŸ‘" ? "ğŸš«" : "ğŸ‘";
      }
    });

  </script>
</body>

</html>